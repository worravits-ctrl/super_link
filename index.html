<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Link Manager - ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (Supabase Only)</title>
    <style>
        :root {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --secondary-color: #f1f5f9;
            --accent-color: #10b981;
            --danger-color: #ef4444;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --border-color: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 1rem;
            min-height: 100vh;
        }

        .header {
            text-align: center;
            margin-bottom: 3rem;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .top-row {
            display: flex;
            gap: 2rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .drop-zone {
            flex: 1;
            min-height: 80px;
            background: white;
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 1rem;
            transition: var(--transition);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .drop-zone:hover,
        .drop-zone.drag-over {
            border-color: var(--primary-color);
            background: #f8fafc;
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .drop-zone.drag-over {
            border-color: var(--accent-color);
            background: #f0fdf4;
        }

        .drop-zone-content {
            z-index: 2;
        }

        .drop-zone-icon {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            color: var(--primary-color);
        }

        .search-section {
            flex: 1;
            min-width: 300px;
        }

        .search-input {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: var(--transition);
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .add-form {
            background: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .form-input {
            flex: 1;
            min-width: 250px;
            padding: 0.875rem;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: var(--transition);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 0.875rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-hover);
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .links-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 0.5rem;
            margin-bottom: 2rem;
        }

        .link-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 0.5rem;
            box-shadow: var(--shadow);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            animation: slideIn 0.3s ease-out;
            cursor: grab;
            user-select: none;
        }

        .link-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        /* Drag & Drop visual states */
        .link-card.dragging {
            opacity: 0.6;
            cursor: grabbing;
        }

        .link-card.drag-over {
            outline: 2px dashed var(--primary-color);
            outline-offset: -6px;
        }

        .link-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        .link-favicon {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .link-title {
            font-weight: 600;
            font-size: 0.95rem;
            color: var(--text-primary);
            text-decoration: none;
            flex: 1;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .link-title:hover {
            color: var(--primary-color);
        }

        .link-url {
            color: var(--text-secondary);
            font-size: 0.8rem;
            margin-bottom: 0.5rem;
            word-break: break-all;
        }

        .link-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 0.25rem;
        }

        .btn-delete {
            background: var(--danger-color);
            color: white;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
        }

        .btn-delete:hover {
            background: #dc2626;
        }

        /* Make the Clear All button same size as Remove Duplicates */
        #clearAllBtn.btn-delete {
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
        }

        /* Make bulk delete (top bar) large like other controls */
        #bulkDeleteBtn.btn-delete {
            padding: 0.875rem 1.5rem;
            font-size: 1rem;
        }

        .btn-secondary {
            background: var(--text-secondary);
            color: white;
        }

        .btn-secondary:hover {
            background: #475569;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .import-section {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .import-help {
            color: var(--text-secondary);
            font-size: 0.875rem;
        }

        /* Multi-select styles */
        .link-card .select-checkbox {
            position: static;
            display: none;
            width: 16px;
            height: 16px;
            flex-shrink: 0;
        }

        .select-mode .link-card .select-checkbox {
            display: inline-block;
        }

        .link-card.selected {
            outline: 2px solid var(--primary-color);
            outline-offset: -4px;
            background: #eff6ff;
        }

        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: white;
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.7;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .empty-state p {
            opacity: 0.8;
        }

        .notification {
            position: fixed;
            top: 2rem;
            right: 2rem;
            background: var(--accent-color);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            transform: translateX(400px);
            transition: var(--transition);
            z-index: 1000;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.error {
            background: var(--danger-color);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .drop-zone.drag-over::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 30%, rgba(16, 185, 129, 0.1) 50%, transparent 70%);
            animation: pulse 1s infinite;
        }

        /* Responsive Design */
        @media (max-width: 1200px) {
            .links-grid {
                grid-template-columns: repeat(8, 1fr);
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 0.75rem;
            }

            .header {
                margin-bottom: 2rem;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .header p {
                font-size: 1rem;
            }

            .top-row {
                flex-direction: column;
                gap: 1rem;
            }

            .drop-zone {
                min-height: 70px;
                padding: 1rem;
            }

            .drop-zone-icon {
                font-size: 1.25rem;
            }

            .form-group {
                flex-direction: column;
            }

            .form-input {
                min-width: auto;
            }

            .import-section {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.75rem;
            }

            .links-grid {
                grid-template-columns: repeat(5, 1fr);
                gap: 0.5rem;
            }

            .notification {
                right: 0.75rem;
                left: 0.75rem;
                transform: translateY(-100px);
                font-size: 0.9rem;
            }

            .notification.show {
                transform: translateY(0);
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 0.5rem;
            }

            .header {
                margin-bottom: 1.5rem;
            }

            .header h1 {
                font-size: 1.5rem;
            }

            .header p {
                font-size: 0.9rem;
            }

            .add-form {
                padding: 1rem;
            }

            .link-card {
                padding: 0.4rem;
            }

            .link-header {
                gap: 0.5rem;
            }

            .link-title {
                font-size: 0.9rem;
            }

            .link-url {
                font-size: 0.75rem;
            }

            .btn {
                padding: 0.75rem 1.25rem;
                font-size: 0.9rem;
            }

            .btn-delete {
                padding: 0.2rem 0.4rem;
                font-size: 0.7rem;
            }

            .links-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 0.25rem;
            }

            .drop-zone {
                min-height: 60px;
                padding: 0.75rem;
            }

            .drop-zone h4 {
                font-size: 0.8rem;
            }

            .drop-zone p {
                font-size: 0.7rem;
            }

            .empty-state {
                padding: 2rem 1rem;
            }

            .empty-state-icon {
                font-size: 3rem;
            }

            .empty-state h3 {
                font-size: 1.25rem;
            }
        }
    </style>
    
    <!-- Supabase SDK -->
    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm'
        
        // Supabase Configuration (‡∏à‡∏£‡∏¥‡∏á)
        const supabaseUrl = 'https://nbiqluafzvgwrbelebpx.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5iaXFsdWFmenZnd3JiZWxlYnB4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1OTczNTcsImV4cCI6MjA3MjE3MzM1N30.YV4OqqLFMH3zNuq93E5uAG70rFmRdW3ZCq3jMHGCVfU'
        
        // Initialize Supabase
        const supabase = createClient(supabaseUrl, supabaseKey)
        
        // Make Supabase available globally
        window.supabase = supabase;
        
        console.log('üóÑÔ∏è Supabase initialized');
    </script>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîó Link Manager</h1>
            <p>‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì‡πÉ‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß | üî• ‡πÉ‡∏ä‡πâ Supabase Database ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô</p>

            <div id="supabaseStatus" style="display: block; background: #d1ecf1; color: #0c5460; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #bee5eb;">
                ÔøΩÔ∏è <strong>Supabase:</strong> <span id="supabaseStatusText">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠...</span><br>
                üíæ <strong>‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å:</strong> ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Supabase Database ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô (‡πÑ‡∏°‡πà‡∏°‡∏µ Local Storage)
            </div>
        </div>

        <div class="top-row">
            <div class="drop-zone" id="dropZone">
                <div class="drop-zone-content">
                    <div class="drop-zone-icon">üìé</div>
                    <h4 style="font-size: 0.9rem; margin: 0;">‡∏•‡∏≤‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà</h4>
                    <p style="font-size: 0.75rem; margin: 0; opacity: 0.7;">‡∏´‡∏£‡∏∑‡∏≠‡∏•‡∏≤‡∏Å‡∏à‡∏≤‡∏Å‡πÅ‡∏ñ‡∏ö‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå</p>
                </div>
            </div>

            <div class="search-section">
                <input type="text" class="search-input" id="searchInput" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏•‡∏¥‡∏á‡∏Ñ‡πå...">
            </div>
        </div>

        <div class="add-form">
            <div class="form-group">
                <input type="url" class="form-input" id="urlInput" placeholder="https://example.com">
                <input type="text" class="form-input" id="titleInput" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏•‡∏¥‡∏á‡∏Ñ‡πå (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
                <button class="btn btn-primary" id="addBtn">
                    ‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Ñ‡πå
                </button>
            </div>
            <div class="import-section">
                <input type="file" id="bookmarkFile" accept=".html,.json" style="display: none;">
                <button class="btn btn-secondary" id="importBtn">
                    üìÅ ‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ Bookmarks
                </button>
                <button class="btn btn-secondary" id="removeDuplicatesBtn">
                    üîó ‡∏•‡∏ö‡∏•‡∏¥‡πâ‡∏á‡∏Å‡πå‡∏ã‡πâ‡∏≥
                </button>
                <button class="btn btn-delete" id="clearAllBtn">
                    üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                </button>
                <button class="btn btn-danger" id="clearAllDataBtn" style="background: #dc3545; margin-left: 10px;">
                    üö® ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (Web + Supabase)
                </button>
                <button class="btn btn-secondary" id="checkAndCleanBtn">
                    üõ°Ô∏è ‡∏ï‡∏£‡∏ß‡∏à‡πÅ‡∏•‡∏∞‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢/‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô
                </button>
                <button class="btn btn-secondary" id="bulkSelectToggleBtn">
                    ‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                </button>
                <button class="btn btn-secondary" id="bulkSelectAllBtn" disabled>
                    ‚òëÔ∏è ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á)
                </button>
                <button class="btn btn-delete" id="bulkDeleteBtn" disabled>
                    üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (0)
                </button>
                <button class="btn btn-secondary" id="setApiBtn">
                    ‚öôÔ∏è ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ API
                </button>
                <button class="btn btn-secondary" id="exportBtn">
                    üíæ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å JSON
                </button>
                <button class="btn btn-secondary" id="exportHtmlBtn">
                    üìÅ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å HTML (Chrome)
                </button>
                <span class="import-help">‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡πÑ‡∏ü‡∏•‡πå HTML (Chrome Bookmarks) ‡∏´‡∏£‡∏∑‡∏≠ JSON</span>
            </div>
        </div>

        <div class="links-grid" id="linksGrid"></div>

        <div class="empty-state" id="emptyState" style="display: none;">
            <div class="empty-state-icon">üì≠</div>
            <h3>‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Ñ‡πå</h3>
            <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏£‡∏Å‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì</p>
        </div>
    </div>

    <div class="notification" id="notification"></div>

    <script>
        class LinkManager {
            constructor() {
                this.useSupabase = true; // ‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞ Supabase
                this.supabaseUser = null;
                this.links = []; // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
                this.filteredLinks = [...this.links];
                this.selectMode = false;
                this.selectedIds = new Set();
                this.maxUrlLength = 300; // ‡πÄ‡∏Å‡∏ì‡∏ë‡πå URL ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô
                this.syncIntervalMs = 8000; // ‡∏î‡∏∂‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ó‡∏∏‡∏Å 8 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                this.syncTimer = null;
                this.lastServerHash = '';
                this.initializeElements();
                this.bindEvents();
                // ‡∏£‡∏≠‡πÉ‡∏´‡πâ Supabase ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡πà‡∏≠‡∏ô
                this.setupReorderDnD();
                // Initialize Supabase
                this.initializeSupabase();
            }

            initializeElements() {
                this.dropZone = document.getElementById('dropZone');
                this.searchInput = document.getElementById('searchInput');
                this.urlInput = document.getElementById('urlInput');
                this.titleInput = document.getElementById('titleInput');
                this.addBtn = document.getElementById('addBtn');
                this.linksGrid = document.getElementById('linksGrid');
                this.emptyState = document.getElementById('emptyState');
                this.notification = document.getElementById('notification');
                this.importBtn = document.getElementById('importBtn');
                this.bookmarkFile = document.getElementById('bookmarkFile');
                this.removeDuplicatesBtn = document.getElementById('removeDuplicatesBtn');
                this.clearAllBtn = document.getElementById('clearAllBtn');
                this.checkAndCleanBtn = document.getElementById('checkAndCleanBtn');
                this.bulkSelectToggleBtn = document.getElementById('bulkSelectToggleBtn');
                this.bulkSelectAllBtn = document.getElementById('bulkSelectAllBtn');
                this.bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
                this.exportBtn = document.getElementById('exportBtn');
                this.exportHtmlBtn = document.getElementById('exportHtmlBtn');
            }

            bindEvents() {
                // Drag & Drop Events
                this.dropZone.addEventListener('dragover', this.handleDragOver.bind(this));
                this.dropZone.addEventListener('dragleave', this.handleDragLeave.bind(this));
                this.dropZone.addEventListener('drop', this.handleDrop.bind(this));

                // Form Events
                this.addBtn.addEventListener('click', this.handleAddLink.bind(this));
                this.urlInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleAddLink();
                });
                this.titleInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleAddLink();
                });

                // Search Event
                this.searchInput.addEventListener('input', this.handleSearch.bind(this));

                // Import Events
                this.importBtn.addEventListener('click', () => this.bookmarkFile.click());
                this.bookmarkFile.addEventListener('change', this.handleFileImport.bind(this));

                // Remove Duplicates Event
                this.removeDuplicatesBtn.addEventListener('click', this.handleRemoveDuplicates.bind(this));

                // Clear All Event
                this.clearAllBtn.addEventListener('click', this.handleClearAll.bind(this));

                // Clear All Data Event (Web + Supabase)
                this.clearAllDataBtn = document.getElementById('clearAllDataBtn');
                this.clearAllDataBtn.addEventListener('click', this.handleClearAllData.bind(this));

                // Check and clean unsafe/long URLs
                this.checkAndCleanBtn.addEventListener('click', this.handleCheckAndClean.bind(this));

                // Export functionality
                this.exportBtn.addEventListener('click', () => {
                    this.exportLinks('json');
                });

                this.exportHtmlBtn.addEventListener('click', () => {
                    this.exportLinks('html');
                });

                // Pause/resume autosync with page visibility
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden) {
                        this.stopAutoSync();
                    } else {
                        this.startAutoSync();
                    }
                });

                // Bulk select events
                this.bulkSelectToggleBtn.addEventListener('click', this.toggleSelectMode.bind(this));
                this.bulkSelectAllBtn.addEventListener('click', this.selectAllVisible.bind(this));
                this.bulkDeleteBtn.addEventListener('click', this.deleteSelected.bind(this));

                // Delegated clicks inside grid for selection
                this.linksGrid.addEventListener('click', (e) => {
                    // Handle delete button in any mode
                    const deleteBtn = e.target.closest('[data-delete-id]');
                    if (deleteBtn) {
                        e.preventDefault();
                        e.stopPropagation();
                        const deleteId = Number(deleteBtn.dataset.deleteId);
                        console.log('üóëÔ∏è Delete button clicked for ID:', deleteId);
                        this.deleteLink(deleteId);
                        return;
                    }
                    
                    // Handle selection only in select mode
                    if (!this.selectMode) return;
                    
                    // Prevent link navigate while selecting
                    const a = e.target.closest('a.link-title');
                    if (a) {
                        e.preventDefault();
                    }
                    const checkbox = e.target.closest('.select-checkbox');
                    const card = e.target.closest('.link-card');
                    if (!card) return;
                    const id = Number(card.dataset.id);
                    
                    if (checkbox) {
                        // Checkbox toggled naturally, sync state
                        if (checkbox.checked) this.selectedIds.add(id); else this.selectedIds.delete(id);
                        this.syncCardSelectionUI(card, id);
                        this.updateBulkButtonsState();
                    } else if (!e.target.closest('button') && !e.target.closest('a')) {
                        // Toggle by clicking card area (not buttons or links)
                        if (this.selectedIds.has(id)) this.selectedIds.delete(id); else this.selectedIds.add(id);
                        this.syncCardSelectionUI(card, id);
                        this.updateBulkButtonsState();
                    }
                });
            }

            // ==================== Supabase Methods ====================
            async initializeSupabase() {
                try {
                    if (!window.supabase) {
                        console.log('Supabase not loaded yet, retrying...');
                        setTimeout(() => this.initializeSupabase(), 1000);
                        return;
                    }

                    // Use FIXED user ID for everyone (single user mode)
                    this.supabaseUser = { 
                        id: 'single-user-2025',  // Fixed ID for everyone
                        aud: 'authenticated', 
                        role: 'authenticated' 
                    };
                    this.useSupabase = true;
                    
                    console.log('üóÑÔ∏è Supabase using SINGLE user ID:', this.supabaseUser.id);
                    this.showSupabaseStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à (Single User Mode) üü¢', true);
                    await this.loadFromSupabase();
                    
                } catch (error) {
                    console.error('Supabase initialization error:', error);
                    this.showSupabaseStatus('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ üî¥', false);
                }
            }

            async saveToSupabase() {
                if (!this.useSupabase || !window.supabase) {
                    console.log('‚ùå Supabase not available for saving');
                    return false;
                }
                
                console.log(`üóÑÔ∏è Saving ${this.links.length} links to Supabase...`);
                
                try {
                    // Delete existing links for this user
                    await window.supabase
                        .from('links')
                        .delete()
                        .eq('user_id', this.supabaseUser.id);
                    
                    // Insert all current links
                    if (this.links.length > 0) {
                        const linksToInsert = this.links.map((link, index) => ({
                            user_id: this.supabaseUser.id,
                            url: link.url,
                            title: link.title,
                            favicon: link.favicon,
                            order_index: index,
                            created_at: link.dateAdded || link.addedAt || new Date().toISOString(),
                            updated_at: new Date().toISOString()
                        }));
                        
                        const { error } = await window.supabase
                            .from('links')
                            .insert(linksToInsert);
                        
                        if (error) throw error;
                    }
                    
                    console.log('üóÑÔ∏è Supabase save successful');
                    return true;
                } catch (error) {
                    console.error('Supabase save error:', error);
                    throw error;
                }
            }

            async loadFromSupabase() {
                if (!this.useSupabase || !window.supabase) return false;
                
                try {
                    console.log('üîç Querying Supabase for all links (not filtering by user_id)');
                    
                    const { data: supabaseLinks, error } = await window.supabase
                        .from('links')
                        .select('*')
                        .order('order_index', { ascending: true });
                    
                    if (error) throw error;
                    
                    console.log('üîç Raw Supabase query result:', supabaseLinks);
                    console.log('üîç Found', supabaseLinks?.length || 0, 'links');
                    
                    if (supabaseLinks && supabaseLinks.length > 0) {
                        // Convert Supabase format to app format
                        this.links = supabaseLinks.map(link => ({
                            id: link.id, // ‡πÉ‡∏ä‡πâ Supabase row ID
                            url: link.url,
                            title: link.title,
                            favicon: link.favicon,
                            dateAdded: link.created_at
                        }));
                        
                        this.filteredLinks = [...this.links];
                        this.renderLinks();
                        this.handleSearch();
                        
                        console.log(`üóÑÔ∏è Loaded ${supabaseLinks.length} links from Supabase`);
                    } else {
                        // ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô Supabase - ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡∏ß‡πà‡∏≤‡∏á
                        this.links = [];
                        this.filteredLinks = [];
                        this.renderLinks();
                        console.log('üóÑÔ∏è No data in Supabase - starting fresh');
                        
                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (bypass RLS)
                        const { data: allLinks, error: allError } = await window.supabase
                            .rpc('get_all_links_count');
                        
                        if (!allError && allLinks) {
                            console.log('üîç Total records (RPC):', allLinks);
                        } else {
                            console.log('üîç RPC error:', allError);
                            
                            // ‡∏•‡∏≠‡∏á‡πÉ‡∏ä‡πâ service role key ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π raw data
                            console.log('üîç Trying to check RLS policies...');
                        }
                    }
                    
                    return true;
                } catch (error) {
                    console.error('Supabase load error:', error);
                    return false;
                }
            }

            showSupabaseStatus(message, isConnected = false) {
                const statusElement = document.getElementById('supabaseStatus');
                const statusText = document.getElementById('supabaseStatusText');
                
                if (statusElement && statusText) {
                    statusText.textContent = message;
                    statusElement.style.display = 'block';
                    
                    if (isConnected) {
                        statusElement.style.background = '#d1ecf1';
                        statusElement.style.color = '#0c5460';
                        statusElement.style.borderColor = '#bee5eb';
                    } else {
                        statusElement.style.background = '#f8d7da';
                        statusElement.style.color = '#721c24';
                        statusElement.style.borderColor = '#f5c6cb';
                    }
                    
                    // Auto hide after 5 seconds
                    setTimeout(() => {
                        statusElement.style.transition = 'opacity 0.5s ease-out';
                        statusElement.style.opacity = '0';
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                            statusElement.style.opacity = '1';
                        }, 500);
                    }, 5000);
                }
            }

            // ==================== Firebase Methods (Legacy - Keep for migration) ====================
            async initializeFirebase() {
                try {
                    if (!window.firebaseAuth || !window.firebaseDB) {
                        console.log('Firebase not loaded yet, retrying...');
                        setTimeout(() => this.initializeFirebase(), 1000);
                        return;
                    }

                    const { onAuthStateChanged } = window.firebaseModules;
                    
                    onAuthStateChanged(window.firebaseAuth, (user) => {
                        if (user) {
                            this.firebaseUser = user;
                            this.useFirebase = true;
                            console.log('üî• Firebase authenticated:', user.uid);
                            
                            // Show Firebase status
                            this.showFirebaseStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à üü¢', true);
                            
                            // Load data from Firebase as primary source
                            this.loadFromFirebase();
                            this.showNotification('üî• Firebase ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô!', 'success');
                        } else {
                            this.firebaseUser = null;
                            this.useFirebase = false;
                            
                            // Show Firebase error status
                            const statusElement = document.getElementById('firebaseStatus');
                            const statusText = document.getElementById('firebaseStatusText');
                            if (statusElement && statusText) {
                                statusElement.style.display = 'block';
                                statusText.textContent = '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ üî¥';
                            }
                            
                            console.log('Firebase auth failed');
                        }
                    });
                } catch (error) {
                    console.error('Firebase initialization error:', error);
                    this.showNotification('‚ùå Firebase ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ', 'error');
                }
            }

            async saveToFirebase() {
                if (!this.useFirebase || !window.firebaseDB) {
                    console.log('‚ùå Firebase not available for saving');
                    return false;
                }
                
                console.log(`üî• Saving ${this.links.length} links to Firebase...`);
                
                try {
                    const { collection, addDoc, getDocs, updateDoc, deleteDoc, doc, query, orderBy } = window.firebaseModules;
                    const linksCollection = collection(window.firebaseDB, 'links');
                    
                    // Get existing docs
                    const snapshot = await getDocs(linksCollection);
                    const existingDocs = {};
                    snapshot.forEach(doc => {
                        existingDocs[doc.data().id] = doc.id;
                    });
                    
                    // Update/Add links
                    for (const link of this.links) {
                        const linkData = {
                            id: link.id,
                            url: link.url,
                            title: link.title,
                            favicon: link.favicon,
                            addedAt: link.addedAt || link.dateAdded || new Date().toISOString(),
                            updatedAt: new Date(),
                            userId: this.firebaseUser.uid
                        };
                        
                        if (existingDocs[link.id]) {
                            // Update existing
                            await updateDoc(doc(window.firebaseDB, 'links', existingDocs[link.id]), linkData);
                        } else {
                            // Add new
                            await addDoc(linksCollection, linkData);
                        }
                    }
                    
                    // Delete removed links
                    const currentIds = new Set(this.links.map(l => l.id));
                    for (const [linkId, docId] of Object.entries(existingDocs)) {
                        if (!currentIds.has(parseInt(linkId))) {
                            await deleteDoc(doc(window.firebaseDB, 'links', docId));
                        }
                    }
                    
                    console.log('üî• Firebase save successful!');
                    return true;
                } catch (error) {
                    console.error('Firebase save error:', error);
                    this.showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Firebase ‡πÑ‡∏î‡πâ', 'error');
                    return false;
                }
            }

            async loadFromFirebase() {
                if (!this.useFirebase || !window.firebaseDB) return false;
                
                try {
                    const { collection, getDocs, query, orderBy } = window.firebaseModules;
                    const linksQuery = query(
                        collection(window.firebaseDB, 'links'),
                        orderBy('updatedAt', 'desc')
                    );
                    
                    const snapshot = await getDocs(linksQuery);
                    const firebaseLinks = [];
                    
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.userId === this.firebaseUser.uid) {
                            firebaseLinks.push({
                                id: data.id,
                                url: data.url,
                                title: data.title,
                                favicon: data.favicon,
                                addedAt: data.addedAt || data.dateAdded,
                                dateAdded: data.addedAt || data.dateAdded // ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏±‡∏ô‡πÑ‡∏î‡πâ
                            });
                        }
                    });
                    
                    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏°‡∏µ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏°‡∏µ (Firebase-first approach)
                    this.links = firebaseLinks;
                    this.filteredLinks = [...this.links];
                    this.renderLinks();
                    this.handleSearch(); // Apply any active search
                    
                    console.log(`üî• Loaded ${firebaseLinks.length} links from Firebase`);
                    
                    return true;
                } catch (error) {
                    console.error('Firebase load error:', error);
                    this.showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Firebase ‡πÑ‡∏î‡πâ', 'error');
                    return false;
                }
            }

            showFirebaseStatus(message, isConnected = false) {
                const statusElement = document.getElementById('firebaseStatus');
                const statusText = document.getElementById('firebaseStatusText');
                
                if (statusElement && statusText) {
                    statusText.textContent = message;
                    statusElement.style.display = 'block';
                    
                    if (isConnected) {
                        statusElement.style.background = '#d1ecf1';
                        statusElement.style.color = '#0c5460';
                        statusElement.style.borderColor = '#bee5eb';
                    } else {
                        statusElement.style.background = '#f8d7da';
                        statusElement.style.color = '#721c24';
                        statusElement.style.borderColor = '#f5c6cb';
                    }
                    
                    // Auto hide after 5 seconds
                    setTimeout(() => {
                        statusElement.style.transition = 'opacity 0.5s ease-out';
                        statusElement.style.opacity = '0';
                        setTimeout(() => {
                            statusElement.style.display = 'none';
                            statusElement.style.opacity = '1';
                        }, 500);
                    }, 5000);
                }
            }


            handleCheckAndClean() {
                if (this.links.length === 0) {
                    this.showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', 'error');
                    return;
                }

                const report = this.findUnsafeOrLongLinks();
                const total = report.items.length;
                if (total === 0) {
                    this.showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡∏´‡∏£‡∏∑‡∏≠ URL ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô');
                    return;
                }

                const msgLines = [];
                msgLines.push(`‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢/‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô ${total} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£`);
                if (report.counts.unsafeProtocol > 0) msgLines.push(`- ‡πÇ‡∏õ‡∏£‡πÇ‡∏ï‡∏Ñ‡∏≠‡∏•‡πÑ‡∏°‡πà‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢ (javascript:, data:, file:) ${report.counts.unsafeProtocol}`);
                if (report.counts.nonHttps > 0) msgLines.push(`- ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà HTTPS ${report.counts.nonHttps}`);
                if (report.counts.tooLong > 0) msgLines.push(`- URL ‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô ${this.maxUrlLength} ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£ ${report.counts.tooLong}`);
                if (report.counts.punycode > 0) msgLines.push(`- ‡πÇ‡∏î‡πÄ‡∏°‡∏ô Punycode (xn--) ${report.counts.punycode}`);
                const samples = report.items.slice(0, 10).map(it => `‚Ä¢ ${it.link.title} ‚Äî ${it.link.url.substring(0, 80)}${it.link.url.length>80?'‚Ä¶':''}`);
                if (samples.length) {
                    msgLines.push('\n‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:');
                    msgLines.push(...samples);
                }
                msgLines.push('\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?');

                const confirmed = confirm(msgLines.join('\n'));
                if (!confirmed) return;

                const flagged = new Set(report.items.map(i => i.link.id));
                const before = this.links.length;
                this.links = this.links.filter(l => !flagged.has(l.id));
                const removed = before - this.links.length;
                this.saveLinks();
                this.handleSearch();
                this.showNotification(`‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á/‡∏¢‡∏≤‡∏ß‡πÄ‡∏Å‡∏¥‡∏ô ${removed} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß`);
            }

            findUnsafeOrLongLinks() {
                const counts = { unsafeProtocol: 0, nonHttps: 0, tooLong: 0, punycode: 0 };
                const items = [];
                const seen = new Set();
                const MAX = this.maxUrlLength || 300;

                this.links.forEach(link => {
                    let reasons = [];
                    try {
                        const u = new URL(link.url.startsWith('http') ? link.url : 'https://' + link.url);
                        const proto = u.protocol.toLowerCase();
                        if (proto === 'javascript:' || proto === 'data:' || proto === 'file:') {
                            reasons.push('unsafeProtocol');
                        } else if (proto === 'http:') {
                            reasons.push('nonHttps');
                        }
                        if (u.hostname && u.hostname.startsWith('xn--')) {
                            reasons.push('punycode');
                        }
                    } catch {
                        // ‡∏ñ‡πâ‡∏≤ parse URL ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡πÄ‡∏™‡∏µ‡πà‡∏¢‡∏á
                        reasons.push('unsafeProtocol');
                    }
                    if ((link.url || '').length > MAX) {
                        reasons.push('tooLong');
                    }

                    if (reasons.length) {
                        const key = link.id;
                        if (!seen.has(key)) {
                            seen.add(key);
                            items.push({ link, reasons });
                            // ‡∏ô‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡πÅ‡∏ö‡∏ö unique ‡∏ï‡πà‡∏≠‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£
                            const uniq = new Set(reasons);
                            if (uniq.has('unsafeProtocol')) counts.unsafeProtocol++;
                            if (uniq.has('nonHttps')) counts.nonHttps++;
                            if (uniq.has('tooLong')) counts.tooLong++;
                            if (uniq.has('punycode')) counts.punycode++;
                        }
                    }
                });

                return { counts, items };
            }

            // Drag-and-drop reordering within the grid
            setupReorderDnD() {
                let dragSrcEl = null;
                let dragSrcId = null;

                const onDragStart = (e) => {
                    if (this.selectMode) {
                        e.preventDefault();
                        return;
                    }
                    const card = e.currentTarget;
                    dragSrcEl = card;
                    dragSrcId = Number(card.dataset.id);
                    card.classList.add('dragging');
                    e.dataTransfer.effectAllowed = 'move';
                    // Set a dummy data to enable DnD on Firefox
                    e.dataTransfer.setData('text/plain', '');
                };

                const onDragEnd = (e) => {
                    const card = e.currentTarget;
                    card.classList.remove('dragging');
                    this.linksGrid.querySelectorAll('.link-card').forEach(el => el.classList.remove('drag-over'));
                };

                const onDragOver = (e) => {
                    if (this.selectMode) return;
                    e.preventDefault();
                    e.dataTransfer.dropEffect = 'move';
                    const target = e.currentTarget;
                    if (target !== dragSrcEl) {
                        target.classList.add('drag-over');
                    }
                };

                const onDragLeave = (e) => {
                    e.currentTarget.classList.remove('drag-over');
                };

                const onDrop = async (e) => {
                    if (this.selectMode) return;
                    e.preventDefault();
                    const target = e.currentTarget;
                    target.classList.remove('drag-over');
                    if (!dragSrcEl || target === dragSrcEl) return;

                    const srcId = dragSrcId;
                    const targetId = Number(target.dataset.id);

                    // Reorder this.links based on filtered view positions
                    const srcIndex = this.links.findIndex(l => l.id === srcId);
                    const targetIndex = this.links.findIndex(l => l.id === targetId);
                    if (srcIndex === -1 || targetIndex === -1) return;

                    const [moved] = this.links.splice(srcIndex, 1);
                    this.links.splice(targetIndex, 0, moved);
                    
                    try {
                        await this.saveLinks();
                        this.handleSearch(); // re-render with current filter
                        this.showNotification('‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß');
                    } catch (error) {
                        console.error('Error saving reordered links:', error);
                        this.showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏™‡∏•‡∏±‡∏ö‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÑ‡∏î‡πâ', 'error');
                        // Revert the change
                        this.links.splice(targetIndex, 1);
                        this.links.splice(srcIndex, 0, moved);
                        this.handleSearch();
                    }
                };

                // Attach listeners to current cards
                const attach = () => {
                    this.linksGrid.querySelectorAll('.link-card').forEach(card => {
                        card.setAttribute('draggable', 'true');
                        card.addEventListener('dragstart', onDragStart);
                        card.addEventListener('dragend', onDragEnd);
                        card.addEventListener('dragover', onDragOver);
                        card.addEventListener('dragleave', onDragLeave);
                        card.addEventListener('drop', onDrop);
                    });
                };

                // Initial attach and re-attach on future renders
                const observer = new MutationObserver(() => attach());
                observer.observe(this.linksGrid, { childList: true });
                attach();
            }

            handleDragOver(e) {
                e.preventDefault();
                this.dropZone.classList.add('drag-over');
            }

            handleDragLeave(e) {
                if (!this.dropZone.contains(e.relatedTarget)) {
                    this.dropZone.classList.remove('drag-over');
                }
            }

            handleDrop(e) {
                e.preventDefault();
                this.dropZone.classList.remove('drag-over');

                const url = this.getFirstUrlFromDataTransfer(e.dataTransfer);
                if (url) {
                    this.addLink(url);
                    this.showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ');
                } else {
                    this.showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                }
            }

            getFirstUrlFromDataTransfer(dataTransfer) {
                const text = dataTransfer.getData('text/plain');
                const html = dataTransfer.getData('text/html');
                
                // Check plain text first
                if (this.isValidUrl(text)) {
                    return text;
                }

                // Extract URL from HTML
                if (html) {
                    const urlMatch = html.match(/https?:\/\/[^\s"'>]+/i);
                    if (urlMatch && this.isValidUrl(urlMatch[0])) {
                        return urlMatch[0];
                    }
                }

                return null;
            }

            async handleAddLink() {
                const url = this.urlInput.value.trim();
                const title = this.titleInput.value.trim();

                if (!url) {
                    this.showNotification('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Ñ‡πå', 'error');
                    return;
                }

                if (!this.isValidUrl(url)) {
                    this.showNotification('‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', 'error');
                    return;
                }

                await this.addLink(url, title);
                this.urlInput.value = '';
                this.titleInput.value = '';
                this.showNotification('‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ');
            }

            async addLink(url, title = '') {
                // Ensure URL has protocol
                if (!url.startsWith('http://') && !url.startsWith('https://')) {
                    url = 'https://' + url;
                }

                const link = {
                    id: Date.now(),
                    url: url,
                    title: title || this.extractDomainFromUrl(url),
                    favicon: this.getFaviconUrl(url),
                    dateAdded: new Date().toISOString()
                };

                // Add to beginning of array (newest first)
                this.links.unshift(link);
                try {
                    await this.saveLinks();
                    this.handleSearch(); // Refresh filtered results
                } catch (error) {
                    console.error('Error saving new link:', error);
                    this.showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏î‡πâ', 'error');
                    // Remove the link that failed to save
                    this.links.shift();
                }
            }

            async deleteLink(id) {
                console.log('üóëÔ∏è deleteLink called with ID:', id);
                const linkToDelete = this.links.find(link => link.id === id);
                if (!linkToDelete) {
                    console.error('‚ùå Link not found with ID:', id);
                    return;
                }
                
                this.links = this.links.filter(link => link.id !== id);
                
                try {
                    await this.saveLinks();
                    this.handleSearch(); // Refresh filtered results
                    this.showNotification('‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÅ‡∏•‡πâ‡∏ß');
                    console.log('‚úÖ Link deleted successfully');
                } catch (error) {
                    console.error('Error deleting link:', error);
                    this.showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÑ‡∏î‡πâ', 'error');
                    // Restore the deleted link
                    if (linkToDelete) {
                        this.links.push(linkToDelete);
                        this.handleSearch();
                    }
                }
            }

            handleSearch() {
                const query = this.searchInput.value.toLowerCase().trim();
                
                if (!query) {
                    this.filteredLinks = [...this.links];
                } else {
                    this.filteredLinks = this.links.filter(link => 
                        link.title.toLowerCase().includes(query) || 
                        link.url.toLowerCase().includes(query)
                    );
                }
                
                this.renderLinks();
                this.updateBulkButtonsState();
            }

            renderLinks() {
                if (this.filteredLinks.length === 0) {
                    this.linksGrid.style.display = 'none';
                    this.emptyState.style.display = 'block';
                    return;
                }

                this.linksGrid.style.display = 'grid';
                this.emptyState.style.display = 'none';

                this.linksGrid.innerHTML = this.filteredLinks.map(link => `
                    <div class="link-card ${this.selectedIds.has(link.id) ? 'selected' : ''}" data-id="${link.id}">
                        <div class="link-header">
                            <img src="${link.favicon}" alt="favicon" class="link-favicon" 
                                 onerror="this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%2364748b%22><path d=%22M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z%22/></svg>'">
                            <input type="checkbox" class="select-checkbox" ${this.selectedIds.has(link.id) ? 'checked' : ''} />
                            <a href="${link.url}" target="_blank" class="link-title" title="${link.title}">
                                ${link.title}
                            </a>
                        </div>
                        <div class="link-url">${link.url}</div>
                        <div class="link-actions">
                            <button class="btn btn-delete" data-delete-id="${link.id}">
                                üóëÔ∏è ‡∏•‡∏ö
                            </button>
                        </div>
                    </div>
                `).join('');

                // Toggle select-mode class on container
                if (this.selectMode) {
                    this.containerClassListAdd('select-mode');
                } else {
                    this.containerClassListRemove('select-mode');
                }
            }

            containerClassListAdd(cls){
                // Add a helper to add class on root container for CSS scope
                document.querySelector('.container')?.classList.add(cls);
            }

            containerClassListRemove(cls){
                document.querySelector('.container')?.classList.remove(cls);
            }

            toggleSelectMode(){
                this.selectMode = !this.selectMode;
                if (!this.selectMode) {
                    this.selectedIds.clear();
                }
                this.bulkSelectToggleBtn.textContent = this.selectMode ? '‚úÖ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏•‡∏∑‡∏≠‡∏Å' : '‚úÖ ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£';
                // Enable select all when in select mode and there is something visible
                this.bulkSelectAllBtn.disabled = !this.selectMode || this.filteredLinks.length === 0;
                this.renderLinks();
                this.updateBulkButtonsState();
            }

            selectAllVisible(){
                if (!this.selectMode) return;
                this.filteredLinks.forEach(l => this.selectedIds.add(l.id));
                this.renderLinks();
                this.updateBulkButtonsState();
            }

            deleteSelected(){
                if (this.selectedIds.size === 0) return;
                const count = this.selectedIds.size;
                const confirmed = confirm(`‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
                if (!confirmed) return;

                this.links = this.links.filter(l => !this.selectedIds.has(l.id));
                this.selectedIds.clear();
                this.saveLinks();
                this.handleSearch();
                this.updateBulkButtonsState();
                this.showNotification(`‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå ${count} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß`);
            }

            syncCardSelectionUI(card, id){
                if (this.selectedIds.has(id)) card.classList.add('selected'); else card.classList.remove('selected');
                const cb = card.querySelector('.select-checkbox');
                if (cb) cb.checked = this.selectedIds.has(id);
            }

            updateBulkButtonsState(){
                const count = this.selectedIds.size;
                this.bulkDeleteBtn.disabled = !this.selectMode || count === 0;
                this.bulkDeleteBtn.textContent = `üóëÔ∏è ‡∏•‡∏ö‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (${count})`;
                this.bulkSelectAllBtn.disabled = !this.selectMode || this.filteredLinks.length === 0;
            }

            getFaviconUrl(url) {
                try {
                    const domain = new URL(url).hostname;
                    return `https://www.google.com/s2/favicons?domain=${domain}&sz=16`;
                } catch {
                    return 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="%2364748b"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>';
                }
            }

            extractDomainFromUrl(url) {
                try {
                    return new URL(url).hostname.replace('www.', '');
                } catch {
                    return url;
                }
            }

            isValidUrl(string) {
                try {
                    const url = new URL(string.startsWith('http') ? string : 'https://' + string);
                    return url.protocol === 'http:' || url.protocol === 'https:';
                } catch {
                    return false;
                }
            }

            async saveLinks() {
                // Supabase-first: ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏õ Supabase ‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å
                if (this.useSupabase) {
                    try {
                        await this.saveToSupabase();
                        console.log('ÔøΩÔ∏è Data saved to Supabase successfully');
                    } catch (error) {
                        console.error('‚ùå Supabase save failed:', error);
                        
                        // Supabase-only: ‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πâ localStorage fallback
                        this.showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏õ‡∏¢‡∏±‡∏á Supabase ‡πÑ‡∏î‡πâ', 'error');
                        throw error;
                    }
                } else {
                    console.warn('‚ö†Ô∏è Supabase is not enabled - no data will be saved');
                    this.showNotification('‚ö†Ô∏è Supabase ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô', 'warning');
                }
            }

            loadLinks() {
                // Supabase-only: ‡πÑ‡∏°‡πà‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å localStorage ‡πÅ‡∏•‡πâ‡∏ß
                // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Supabase ‡πÉ‡∏ô initializeSupabase() ‡πÅ‡∏ó‡∏ô
                console.log('ÔøΩ loadLinks() - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏≤‡∏Å Supabase ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô');
                return []; // ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡∏≠‡∏≤‡∏£‡πå‡πÄ‡∏£‡∏¢‡πå‡∏ß‡πà‡∏≤‡∏á
            }

            async checkApiAvailable() {
                const base = this.apiBase;
                if (!base) return; // stay offline
                try {
                    const resolved = await this.resolveApiEndpoint(base);
                    if (!resolved) throw new Error('API ‡πÑ‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');
                    this.apiEndpointResolved = resolved;
                    const serverLinks = await this.fetchServerLinks(resolved);
                    if (!Array.isArray(serverLinks)) throw new Error('‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á');
                    this.isOnlineStorage = true;
                    
                    // Check if running on serverless (Vercel)
                    const isServerless = this.apiEndpointResolved.includes('vercel.app') || this.apiEndpointResolved.includes('vercel.com');
                    
                    if (isServerless) {
                        // For serverless: prioritize localStorage, only use server as fallback
                        if (this.links.length > 0) {
                            // Keep existing localStorage data and sync it to server
                            await this.syncAllToServer();
                        } else if (serverLinks.length > 0) {
                            // Only use server data if localStorage is empty
                            this.links = serverLinks;
                            localStorage.setItem('linkManager_links', JSON.stringify(this.links));
                        }
                    } else {
                        // For persistent servers: prefer server data
                        this.links = serverLinks.length ? serverLinks : this.links;
                        if (serverLinks.length === 0 && this.links.length > 0) {
                            await this.syncAllToServer();
                        }
                    }
                    
                    this.handleSearch();
                    this.lastServerHash = this.computeHash(this.links);
                    
                    if (isServerless) {
                        this.showNotification(`‚ö†Ô∏è ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: Serverless (‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô Browser)`);
                        // Show serverless warning
                        const warning = document.getElementById('serverlessWarning');
                        if (warning) {
                            warning.style.display = 'block';
                            
                            // ‡∏¢‡∏∏‡∏ö‡πÅ‡∏ñ‡∏ö‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å 3 ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ
                            setTimeout(() => {
                                warning.style.transition = 'opacity 0.5s ease-out';
                                warning.style.opacity = '0';
                                setTimeout(() => {
                                    warning.style.display = 'none';
                                    warning.style.opacity = '1'; // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡πà‡∏≠‡πÑ‡∏õ
                                }, 500);
                            }, 3000);
                        }
                    } else {
                        this.showNotification(`üåê ‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ô‡πÑ‡∏•‡∏ô‡πå: ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à`);
                    }
                    this.startAutoSync();
                } catch (err) {
                    // stay offline, but notify briefly in console
                    console.warn('API unavailable:', err?.message || err);
                }
            }

            async resolveApiEndpoint(base) {
                const candidates = [];
                const trimmed = base.replace(/\/$/, '');
                // If looks like full endpoint already
                if (/links(\.php)?$/.test(trimmed)) {
                    candidates.push(trimmed);
                } else {
                    candidates.push(`${trimmed}/links.php`);
                    candidates.push(`${trimmed}/links`);
                }
                for (const url of candidates) {
                    try {
                        const r = await fetch(url, { method: 'GET', cache: 'no-store' });
                        if (r.ok) {
                            const j = await r.json();
                            if (Array.isArray(j)) return url;
                        }
                    } catch {}
                }
                return '';
            }

        async syncAllToServer() {
                try {
            const endpoint = this.apiEndpointResolved || (await this.resolveApiEndpoint(this.apiBase));
            if (!this.isOnlineStorage || !endpoint) throw new Error('offline');
            const res = await fetch(endpoint, {
                        method: 'PUT',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(this.links)
                    });
                    if (!res.ok) throw new Error('sync failed');
                    this.lastServerHash = this.computeHash(this.links);
                } catch {
                    console.log('‚ö†Ô∏è Server sync failed, will retry later');
                }
            }

            async fetchServerLinks(endpointOverride = '') {
                const endpoint = endpointOverride || this.apiEndpointResolved || (await this.resolveApiEndpoint(this.apiBase));
                const res = await fetch(endpoint, { method: 'GET', cache: 'no-store' });
                if (!res.ok) throw new Error(`API ${res.status}`);
                return res.json();
            }

            computeHash(list) {
                try {
                    // Simple deterministic hash from JSON string
                    const s = JSON.stringify(list);
                    let h = 0;
                    for (let i = 0; i < s.length; i++) {
                        h = ((h << 5) - h) + s.charCodeAt(i);
                        h |= 0;
                    }
                    return String(h);
                } catch {
                    return String(Date.now());
                }
            }

            startAutoSync() {
                this.stopAutoSync();
                if (!this.isOnlineStorage) return;
                this.syncTimer = setInterval(async () => {
                    try {
                        const serverLinks = await this.fetchServerLinks();
                        const serverHash = this.computeHash(serverLinks);
                        if (serverHash !== this.lastServerHash) {
                            this.links = serverLinks;
                            this.lastServerHash = serverHash;
                            this.handleSearch();
                        }
                    } catch (e) {
                        // temporary failure: keep offline cache and retry next tick
                    }
                }, this.syncIntervalMs);
            }

            stopAutoSync() {
                if (this.syncTimer) {
                    clearInterval(this.syncTimer);
                    this.syncTimer = null;
                }
            }

            getInitialApiBase(resetToDefault = false) {
                // Priority: URL param ?api=... -> localStorage -> default
                if (!resetToDefault) {
                    const url = new URL(window.location.href);
                    const apiParam = url.searchParams.get('api');
                    if (apiParam) {
                        const base = apiParam.replace(/\/$/, '');
                        localStorage.setItem('linkManager_apiBase', base);
                        return base;
                    }
                    const saved = localStorage.getItem('linkManager_apiBase');
                    if (saved) return saved;
                }
                
                // Auto-detect environment and set appropriate API base
                const hostname = location.hostname;
                const protocol = location.protocol;
                
                // Production on Vercel
                if (hostname.includes('vercel.app') || hostname.includes('vercel.com')) {
                    return `${protocol}//${hostname}/api`;
                }
                
                // Custom domain (production)
                if (hostname !== 'localhost' && hostname !== '127.0.0.1' && !hostname.includes('192.168')) {
                    return `${protocol}//${hostname}/api`;
                }
                
                // Local development with Node.js server
                if ((hostname === 'localhost' || hostname === '127.0.0.1') && location.port === '3000') {
                    return `${protocol}//${hostname}:${location.port}/api`;
                }
                
                // Default: if app is served under /super_link/, assume API at /super_link/api on same host (XAMPP)
                if (location.pathname.includes('/super_link/')) return '/super_link/api';
                
                // Local XAMPP
                if (hostname === 'localhost' || hostname === '127.0.0.1') return '/super_link/api';
                
                // Otherwise no default API (offline until user sets one)
                return '';
            }

            setApiBase(base) {
                this.apiBase = base;
                localStorage.setItem('linkManager_apiBase', base);
            }

            handleFileImport(e) {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const content = event.target.result;
                        let importedLinks = [];

                        if (file.name.endsWith('.json')) {
                            importedLinks = this.parseJsonBookmarks(content);
                        } else if (file.name.endsWith('.html')) {
                            importedLinks = this.parseHtmlBookmarks(content);
                        }

                        if (importedLinks.length > 0) {
                            this.importLinks(importedLinks);
                            this.showNotification(`‡∏ô‡∏≥‡πÄ‡∏Ç‡πâ‡∏≤ ${importedLinks.length} ‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! üéâ`);
                        } else {
                            this.showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå', 'error');
                        }
                    } catch (error) {
                        this.showNotification('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ', 'error');
                    }
                };
                reader.readAsText(file);
                
                // Reset file input
                e.target.value = '';
            }

            parseJsonBookmarks(content) {
                try {
                    const data = JSON.parse(content);
                    const links = [];

                    // Handle different JSON formats
                    if (Array.isArray(data)) {
                        // Simple array format
                        data.forEach(item => {
                            if (item.url || item.href) {
                                links.push({
                                    url: item.url || item.href,
                                    title: item.title || item.name || this.extractDomainFromUrl(item.url || item.href)
                                });
                            }
                        });
                    } else if (data.bookmarks || data.children) {
                        // Chrome/Firefox export format
                        this.extractLinksFromBookmarkTree(data.bookmarks || data.children, links);
                    }

                    return links;
                } catch {
                    return [];
                }
            }

            parseHtmlBookmarks(content) {
                const links = [];
                const parser = new DOMParser();
                const doc = parser.parseFromString(content, 'text/html');
                const anchors = doc.querySelectorAll('a[href]');

                anchors.forEach(anchor => {
                    const url = anchor.getAttribute('href');
                    const title = anchor.textContent.trim() || this.extractDomainFromUrl(url);
                    
                    if (this.isValidUrl(url)) {
                        links.push({ url, title });
                    }
                });

                return links;
            }

            extractLinksFromBookmarkTree(nodes, links) {
                if (!Array.isArray(nodes)) return;

                nodes.forEach(node => {
                    if (node.url && this.isValidUrl(node.url)) {
                        links.push({
                            url: node.url,
                            title: node.name || node.title || this.extractDomainFromUrl(node.url)
                        });
                    }
                    
                    if (node.children) {
                        this.extractLinksFromBookmarkTree(node.children, links);
                    }
                });
            }

            importLinks(importedLinks) {
                let addedCount = 0;
                
                importedLinks.forEach(linkData => {
                    // Check if link already exists
                    const exists = this.links.some(existing => existing.url === linkData.url);
                    
                    if (!exists) {
                        const link = {
                            id: Date.now() + Math.random(),
                            url: linkData.url,
                            title: linkData.title,
                            favicon: this.getFaviconUrl(linkData.url),
                            dateAdded: new Date().toISOString()
                        };
                        
                        this.links.unshift(link);
                        addedCount++;
                    }
                });

                if (addedCount > 0) {
                    this.saveLinks();
                    this.handleSearch();
                }

                return addedCount;
            }

            handleRemoveDuplicates() {
                if (this.links.length === 0) {
                    this.showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö', 'error');
                    return;
                }

                const originalCount = this.links.length;
                const uniqueLinks = [];
                const seenUrls = new Set();

                // Keep only unique URLs (first occurrence)
                this.links.forEach(link => {
                    const normalizedUrl = link.url.toLowerCase().replace(/\/$/, ''); // Remove trailing slash and convert to lowercase
                    if (!seenUrls.has(normalizedUrl)) {
                        seenUrls.add(normalizedUrl);
                        uniqueLinks.push(link);
                    }
                });

                const duplicatesCount = originalCount - uniqueLinks.length;

                if (duplicatesCount === 0) {
                    this.showNotification('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ã‡πâ‡∏≥! ‚ú®');
                    return;
                }

                const confirmed = confirm(`‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ã‡πâ‡∏≥ ${duplicatesCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£\n‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ã‡πâ‡∏≥‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`);
                
                if (confirmed) {
                    this.links = uniqueLinks;
                    this.saveLinks();
                    this.handleSearch();
                    this.showNotification(`‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ã‡πâ‡∏≥ ${duplicatesCount} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏•‡πâ‡∏ß! üßπ`);
                }
            }

            handleClearAll() {
                if (this.links.length === 0) {
                    this.showNotification('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏•‡πâ‡∏≤‡∏á', 'error');
                    return;
                }

                const confirmed = confirm(`‡∏Ñ‡∏∏‡∏ì‡πÅ‡∏ô‡πà‡πÉ‡∏à‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡∏•‡∏¥‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${this.links.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£?\n\n‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ`);
                
                if (confirmed) {
                    this.links = [];
                    this.saveLinks();
                    this.handleSearch();
                    this.showNotification('‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß! üßπ');
                }
            }

            async handleClearAllData() {
                const confirmed = confirm(
                    `üö® ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î\n\n` +
                    `‡∏à‡∏∞‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏±‡∏á‡∏ô‡∏µ‡πâ:\n` +
                    `‚Ä¢ ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö\n` +
                    `‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Supabase Database\n\n` +
                    `‚ö†Ô∏è ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡πÑ‡∏î‡πâ!\n\n` +
                    `‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`
                );
                
                if (!confirmed) return;

                try {
                    this.showNotification('üîÑ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î...', 'info');

                    // 1. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö
                    this.links = [];
                    this.filteredLinks = [];
                    this.renderLinks();

                    // 2. ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Supabase
                    if (this.useSupabase && window.supabase) {
                        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á (‡∏ó‡∏∏‡∏Å user)
                        const { error } = await window.supabase
                            .from('links')
                            .delete()
                            .gte('id', 0); // ‡∏•‡∏ö‡∏ó‡∏∏‡∏Å‡πÅ‡∏ñ‡∏ß

                        if (error) {
                            console.error('‚ùå Supabase clear error:', error);
                            throw error;
                        }

                        console.log('‚úÖ Supabase data cleared');
                    }

                    const successMessage = 
                        `‚úÖ ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏¥‡πâ‡∏ô!\n\n` +
                        `üìä ‡∏™‡∏¥‡πà‡∏á‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏•‡∏ö:\n` +
                        `‚Ä¢ ‡∏•‡∏¥‡πâ‡∏á‡∏Ñ‡πå‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö\n` +
                        `‚Ä¢ ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ô Supabase Database\n\n` +
                        `üéâ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏õ‡πá‡∏ô Supabase-only Mode ‡πÅ‡∏•‡πâ‡∏ß!`;

                    this.showNotification(successMessage, 'success');
                    console.log('üßπ All data cleared successfully');

                } catch (error) {
                    console.error('‚ùå Clear all data error:', error);
                    this.showNotification('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ' + error.message, 'error');
                }
            }

            showNotification(message, type = 'success') {
                this.notification.textContent = message;
                this.notification.className = `notification ${type}`;
                this.notification.classList.add('show');

                setTimeout(() => {
                    this.notification.classList.remove('show');
                }, 3000);
            }

            exportLinks(format = 'json') {
                try {
                    let dataStr, fileName, mimeType;
                    const currentDate = new Date().toISOString().split('T')[0];
                    
                    if (format === 'html') {
                        // Chrome Bookmarks HTML format
                        dataStr = this.generateChromeBookmarksHTML();
                        fileName = `bookmarks_${currentDate}.html`;
                        mimeType = 'text/html';
                    } else {
                        // JSON format
                        const data = {
                            exportDate: new Date().toISOString(),
                            linksCount: this.links.length,
                            links: this.links
                        };
                        dataStr = JSON.stringify(data, null, 2);
                        fileName = `super-link-backup-${currentDate}.json`;
                        mimeType = 'application/json';
                    }
                    
                    const dataBlob = new Blob([dataStr], {type: mimeType});
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(dataBlob);
                    link.download = fileName;
                    link.click();
                    
                    this.showNotification(`üíæ ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${this.links.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (${format.toUpperCase()}) ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!`);
                } catch (error) {
                    this.showNotification('‚ùå ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ', 'error');
                }
            }

            generateChromeBookmarksHTML() {
                const currentDate = new Date().toISOString();
                const timestamp = Math.floor(Date.now() / 1000);
                
                let html = `<!DOCTYPE NETSCAPE-Bookmark-file-1>
<!-- This is an automatically generated file.
     It will be read and overwritten.
     DO NOT EDIT! -->
<META HTTP-EQUIV="Content-Type" CONTENT="text/html; charset=UTF-8">
<TITLE>Bookmarks</TITLE>
<H1>Bookmarks</H1>
<DL><p>
    <DT><H3 ADD_DATE="${timestamp}" LAST_MODIFIED="${timestamp}" PERSONAL_TOOLBAR_FOLDER="true">Bookmarks bar</H3>
    <DL><p>
        <DT><H3 ADD_DATE="${timestamp}" LAST_MODIFIED="${timestamp}">Super Link Manager</H3>
        <DL><p>
`;

                this.links.forEach(link => {
                    const addDate = link.dateAdded ? Math.floor(new Date(link.dateAdded).getTime() / 1000) : timestamp;
                    const escapedTitle = this.escapeHtml(link.title || 'Untitled');
                    const escapedUrl = this.escapeHtml(link.url);
                    
                    html += `            <DT><A HREF="${escapedUrl}" ADD_DATE="${addDate}">${escapedTitle}</A>\n`;
                });

                html += `        </DL><p>
    </DL><p>
</DL><p>`;

                return html;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // Initialize the app
        const linkManager = new LinkManager();
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'976a1708178ad43a',t:'MTc1NjQ0OTk3Mi4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
